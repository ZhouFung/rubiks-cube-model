# Rubik's Cube 单层旋转动画设计方案

## 1. 需求拆解
- 用户输入公式（如 "R"），3D 魔方模型对应单层发生旋转动画。
- 动画完成后，魔方状态与 cubejs 数据同步。
- 支持多步公式连续动画（如 "R U R' U'"），每步动画顺序执行。
- 动画过程可暂停、回退、快进。

## 2. 技术方案细化


### 2.2 动画实现方式（物理分组与坐标变换）
- 推荐动画库：
  - **GSAP**（GreenSock Animation Platform）：高性能、易用，适合 Three.js 3D 场景动画。
  - **React Spring**：适合 React 组件动画，支持与 @react-three/fiber 集成。
- Cube3D 只负责动画和渲染，不直接操作 cubejs。
- CubeAdapter 只负责数据，不负责动画。
- App.tsx 负责 move 队列、动画调度和状态同步。
- 动画流程：
  1. 选中目标层 cubie，临时将其加入一个 Three.Group。
  2. 对 Group 进行旋转动画（如绕 y 轴旋转 90°），动画实现可用 GSAP 或 React Spring。
  3. 动画完成后，遍历 Group 内 cubie，按旋转矩阵物理变换 position/orientation，然后移回主场景。
  4. cubejs.move() 更新魔方状态，刷新贴色。
- 用户输入公式（如 "R U R' U'"），App.tsx 解析为 moveQueue（如 ["R", "U", "R'", "U'"]）。
- moveQueue 逐步执行，每步动画完成后 cubejs 更新状态并刷新贴色。
- 禁止动画期间再次触发 move，保证队列顺序。
- 动画完成后，将 cubie 从 Group 移回主场景，并更新其坐标和朝向（物理变换）。

triggerLayerRotate(move: string, onEnd?: () => void)：支持所有层动画（U, D, F, B, L, R 及其逆/双转），通过参数控制动画轴和 cubie 选择。
动画完成后回调 onEnd，通知 App.tsx 继续队列。
### 2.3 动画与 cubejs 状态同步
- 动画开始前，先用 cubejs 计算新状态，但只在动画结束后刷新贴色。
 App.tsx 维护 moveQueue，每次 move 只入队，逐步触发 Cube3D 动画。
 动画结束后出队并更新 cubejs 状态。
- 动画过程中，3D模型与 cubejs 状态暂时不同步，动画结束后同步。

 支持暂停/回退/快进，动画队列可随时中断或回溯。
 支持高亮当前旋转层。
### 2.4 公式队列与动画调度
- 队列逐步执行，每步动画完成后触发下一步。

### 2.5 交互与扩展
- 支持暂停/回退/快进：动画队列可随时中断或回溯。
- 支持高亮当前旋转层，提升教学效果。

## 3. 关键点与难点
- 精确选中并旋转目标层 cubie，避免错位和穿插。
- 动画与 cubejs 状态同步时机要准确，防止视觉与数据不一致。
- 多步公式动画队列的调度与状态回溯。

## 4. 推荐开发步骤

1. 魔方建模与分层分组
   - 使用 Three.js/@react-three/fiber 创建 3x3x3 魔方，每个 cubie 独立 Mesh。
   - 按坐标分组，便于后续选中单层（如 U 层所有 cubie 的 y 坐标相同）。

2. 单层选中与分组
   - 实现根据公式（如 "U"）选中目标层 cubie。
   - 将目标 cubie 临时加入 Three.Group，便于整体旋转。

3. 单步旋转动画实现
   - 使用React Spring 对 Group 进行旋转动画（如 y 轴 90°）。
   - 动画完成后，将 cubie 从 Group 移回场景，并更新坐标和朝向。

4. cubejs 状态同步与贴色刷新
   - 动画完成后，调用 cubejs.move() 更新魔方状态。
   - 根据新状态刷新 cubie 贴色。

5. 公式队列与动画调度
   - 用户输入公式后，解析为动画队列（如 ["R", "U", "R'", "U'"]）。
   - 队列逐步执行，每步动画完成后触发下一步。

6. 交互扩展
   - 支持暂停、回退、快进等动画控制。
   - 支持高亮当前旋转层。
   - 增加动画完成回调，便于教学流程控制。
